stages:
    - build
  
link-checker-mlc:
    stage: build
    image: rust:latest
    script:
        - curl -L https://github.com/becheran/mlc/releases/download/v0.7.0/mlc -o mlc
        - chmod +x mlc
        - ./mlc --ignore-links "http*://crates.io*"
    allow_failure: true

build-rust-nightly:
    stage: build
    image: rustlang/rust:nightly
    script:
        - cargo build --verbose
        - cargo test --verbose

build-rust:
    stage: build
    image: rust:latest
    script:
        - cargo build --verbose
        - cargo test --verbose
        - |
            wget https://github.com/SimonKagstrom/kcov/archive/master.tar.gz &&
            tar xzf master.tar.gz &&
            cd kcov-master &&
            mkdir build &&
            cd build &&
            cmake .. &&
            make &&
            make install DESTDIR=../../kcov-build &&
            cd ../.. &&
            rm -rf kcov-master &&
            for file in target/debug/examplerust-*; do [ -x "${file}" ] || continue; mkdir -p "target/cov/$(basename $file)"; ./kcov-build/usr/local/bin/kcov --exclude-pattern=/.cargo,/usr/lib --verify "target/cov/$(basename $file)" "$file"; done &&
            bash <(curl -s https://codecov.io/bash) &&
            echo "Uploaded code coverage"